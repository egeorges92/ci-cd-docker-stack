version: "2"

volumes:
  jenkins-data:
    driver: "local"
  jenkins-slave-data:
    driver: "local"
  postgres-data:
    driver: "local"
  nexus-data:
    driver: "local"
  gitea-data:
    driver: "local"
  sonarqube-data:
    driver: "local"

networks:
  front:
    driver: bridge
  back:
    driver: bridge

services:
  nginx:
    build: ./nginx
    image: cicd/nginx
    container_name: nginx
    ports:
      - "80:80"
    depends_on:
      - nexus
      - jenkins-master
      - sonarqube
      - gitea
    volumes:
      - ${pwd}/nginx/conf.d:/etc/nginx/conf.d:ro
    networks:
      - front
  openldap:
    build: ./openldap
    image: cicd/openldap
    container_name: openldap
    tty: true
    stdin_open: true
    hostname: "openldap"
    networks:
      - back
  postgres:
    build: ./postgres
    image: cicd/postgres
    container_name: postgres
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "secret"
      POSTGRES_DB: "postgres"
    restart: always
    volumes:
      - postgres-data:/var/lib/postgresql/data:rw
      - ${pwd}/postgres/initdb.d:/docker-entrypoint-initdb.d:ro
    networks:
      - back
  jenkins-master:
    build: ./jenkins
    container_name: jenkins-master
    image: cicd/jenkins
    privileged: true
    stdin_open: true
    tty: true
    restart: always
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins-data:/var/jenkins_home
    depends_on:
      - openldap
    networks:
      - front
      - back
  jenkins-slave:
    build: ./jenkins-slave
    container_name: jenkins-slave-1
    image: cicd/jenkins-slave
    environment:
      - JENKINS_URL=http://jenkins-master:8080/
      - JENKINS_SECRET=1aeac819877b4f3c70635a5ea1e7a7c49bb01fa93da31adbbbe74ed883702113
      - JENKINS_AGENT_NAME=slave-1
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins-slave-data:/var/jenkins_home
    networks:
      - back
  gitea:
    build: ./gitea
    container_name: gitea
    image: cicd/gitea
    volumes:
      - gitea-data:/data
    depends_on:
      - openldap
      - postgres
    networks:
      - front
      - back
  nexus:
    build: ./nexus
    container_name: nexus
    image: cicd/nexus
    volumes:
      - nexus-data:/nexus-data:rw
    depends_on:
      - openldap
    networks:
      - front
      - back
  sonarqube:
    build: ./sonarqube
    container_name: sonarqube
    image: cicd/sonarqube
    environment:
      - SONARQUBE_JDBC_USERNAME=sonar
      - SONARQUBE_JDBC_PASSWORD=secret
      - SONARQUBE_JDBC_URL=jdbc://postgresql://postgres/sonar
    depends_on:
      - openldap
      - postgres
    networks:
      - front
      - back
  
